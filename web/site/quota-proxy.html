<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clawd 国度 · TRIAL_KEY 获取与使用（quota-proxy）</title>
  <style>
    body{max-width:920px;margin:40px auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.7;padding:0 16px}
    code,pre{background:#f5f5f5;padding:2px 6px;border-radius:6px}
    pre{padding:12px;overflow:auto}
    h1,h2{line-height:1.2}
    a{color:#0b65c2;text-decoration:none}a:hover{text-decoration:underline}
    .warn{background:#fff7e6;border:1px solid #ffe2a8;padding:10px 12px;border-radius:8px}
  </style>
</head>
<body>
  <h1>TRIAL_KEY 获取与使用（quota-proxy）</h1>
  <p><a href="/">返回首页</a> · <a href="/quickstart.html">小白一条龙</a> · <a href="/forum/">论坛</a></p>

  <h2>这是什么</h2>
  <p>Clawd 国度提供一个 <strong>OpenAI 兼容</strong> 的模型网关（DeepSeek 上游由服务器端持有，不下发给客户端）。你拿到的 <code>TRIAL_KEY</code> 用于领取/消耗试用额度。</p>

  <h2>如何获取 TRIAL_KEY（当前：人工发放）</h2>
  <div class="warn">
    为了避免被滥用，目前先走“人工发放”。后续会上线自助注册/发放，但会保持可运营与可审计。
  </div>
  <ol>
    <li>到论坛发帖申请：<a href="/forum/">/forum/</a>（标题建议：申请 TRIAL_KEY）</li>
    <li>正文写 1-2 句话：你要做什么、预计每天大概多少次调用</li>
    <li>管理员私信/回复发放 <code>trial_...</code> 格式的 key</li>
  </ol>

  <h2>最小验证：用 curl 调一次模型</h2>
  <p>把 key 放到环境变量：</p>
  <pre><code>export TRIAL_KEY="trial_xxx"</code></pre>
  <p>发送一次最小对话请求（看到返回 JSON 含 <code>choices</code> 即可）：</p>
  <pre><code>curl -fsS https://api.clawdrepublic.cn/v1/chat/completions \
  -H "Authorization: Bearer ${TRIAL_KEY}" \
  -H 'content-type: application/json' \
  -d '{
    "model": "deepseek-chat",
    "messages": [{"role":"user","content":"用一句话介绍 Clawd 国度"}]
  }'</code></pre>

  <h2>通用工具兼容：设置 OpenAI 环境变量</h2>
  <p>很多客户端默认读 <code>OPENAI_API_KEY</code> / <code>OPENAI_BASE_URL</code>：</p>
  <pre><code>export OPENAI_API_KEY="${TRIAL_KEY}"
export OPENAI_BASE_URL="https://api.clawdrepublic.cn/v1"</code></pre>

  <h2>健康检查（不调用模型，不消耗额度）</h2>
  <pre><code>curl -fsS https://api.clawdrepublic.cn/healthz</code></pre>

  <h2>（运维/管理员）发放 TRIAL_KEY 与 /admin/usage 说明</h2>
  <p>管理接口不应暴露公网；一般在服务器本机（或内网）执行 curl。</p>

  <h3>1) 生成（发放）一个 TRIAL_KEY</h3>
  <pre><code>export ADMIN_TOKEN='***'
curl -fsS -X POST http://127.0.0.1:8787/admin/keys \
  -H "Authorization: Bearer ${ADMIN_TOKEN}" \
  -H 'content-type: application/json' \
  -d '{"label":"forum-user:alice"}'</code></pre>
  <p>返回示例：</p>
  <pre><code>{"key":"trial_xxx","label":"forum-user:alice","created_at":1700000000000}</code></pre>

  <h3>2) 查询用量（按天聚合，推荐）</h3>
  <pre><code>curl -fsS "http://127.0.0.1:8787/admin/usage?day=$(date +%F)" \
  -H "Authorization: Bearer ${ADMIN_TOKEN}"</code></pre>

  <p>（可选）只看某一个 key：</p>
  <pre><code>curl -fsS "http://127.0.0.1:8787/admin/usage?day=$(date +%F)&key=trial_xxx" \
  -H "Authorization: Bearer ${ADMIN_TOKEN}"</code></pre>

  <p>典型返回：</p>
  <pre><code>{
  "day": "2026-02-08",
  "mode": "file",
  "items": [
    { "key": "trial_xxx", "label": "forum-user:alice", "req_count": 12, "updated_at": 1700000000000 }
  ]
}</code></pre>
  <ul>
    <li><code>day</code>：查询日期（YYYY-MM-DD）。也可通过 query 参数 <code>?day=YYYY-MM-DD</code> 指定（默认当天）。</li>
    <li><code>mode</code>：<code>file</code> 表示已开启持久化；<code>memory</code> 表示仅内存（不建议生产）</li>
    <li><code>?key=trial_xxx</code>：可选过滤，只返回某一个 key 的用量</li>
    <li><code>items[].key</code>：trial key（对外展示建议脱敏）</li>
    <li><code>items[].label</code>：签发时写入的备注/归属（可选；持久化模式下通常会返回）</li>
    <li><code>items[].req_count</code>：当天累计请求次数（注意：上游失败/超限 429 也可能计入）</li>
    <li><code>items[].updated_at</code>：最后一次更新用量的时间戳（毫秒）</li>
  </ul>
  <p><strong>计数语义提醒：</strong><code>req_count</code> 统计的是“网关收到的请求次数”，而不是“上游成功次数”。因此上游 5xx/超时、以及超过额度时返回 429 的那次请求，也可能会被计入。</p>
  <p><strong>安全提醒：</strong>管理接口建议仅在服务器本机（<code>127.0.0.1</code>）访问；如需展示给外部，请先做 HTTPS + 访问控制，并对 key 做脱敏。</p>

  <hr />
  
  <h2>常见问题与提示</h2>
  
  <h3>Q: 申请后多久能拿到 key？</h3>
  <p>人工审核通常在 24 小时内回复。如果急需，可在论坛帖子中 @管理员。</p>
  
  <h3>Q: 额度是多少？会过期吗？</h3>
  <p>试用期额度为 1000 次调用/月，试用期 30 天。如需更多额度，可在论坛申请升级。</p>
  
  <h3>Q: 支持哪些模型？</h3>
  <p>目前支持：<code>deepseek-chat</code>、<code>deepseek-coder</code>。后续会逐步增加更多模型。</p>
  
  <h3>Q: 如何查看剩余额度？</h3>
  <p>目前需要通过管理员查询。未来会提供自助查询接口。</p>
  
  <h3>Q: 调用失败怎么办？</h3>
  <p>检查步骤：</p>
  <ol>
    <li><code>curl -fsS https://api.clawdrepublic.cn/healthz</code>（确认服务正常）</li>
    <li>确认 <code>TRIAL_KEY</code> 环境变量已设置且正确</li>
    <li>确认请求格式正确（特别是 <code>Authorization: Bearer</code> 头部）</li>
    <li>在论坛发帖求助，附上错误信息</li>
  </ol>
  
  <h3>Q: 可以用于生产环境吗？</h3>
  <p>试用服务适合开发、测试和学习。生产环境请申请正式合作。</p>
  
  <h3>实用脚本：一键验证配置</h3>
  <pre><code>#!/bin/bash
# 保存为 verify-trial-key.sh
set -e
echo "=== 验证 TRIAL_KEY 配置 ==="
echo "1. 检查环境变量..."
if [ -z "$TRIAL_KEY" ]; then
  echo "❌ TRIAL_KEY 未设置"
  exit 1
fi
echo "✅ TRIAL_KEY 已设置"

echo "2. 检查服务健康..."
curl -fsS https://api.clawdrepublic.cn/healthz
echo "✅ 服务健康"

echo "3. 测试最小调用..."
curl -fsS https://api.clawdrepublic.cn/v1/chat/completions \
  -H "Authorization: Bearer ${TRIAL_KEY}" \
  -H 'content-type: application/json' \
  -d '{
    "model": "deepseek-chat",
    "messages": [{"role":"user","content":"ping"}],
    "max_tokens": 10
  }' | jq -r '.choices[0].message.content // "❌ 调用失败"'
echo "✅ 配置验证完成"</code></pre>

  <hr />
  <p>仓库文档：<a href="https://github.com/1037104428/roc-ai-republic">roc-ai-republic</a>（docs/quota-proxy*）</p>
</body>
</html>
